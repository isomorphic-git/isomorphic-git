/* eslint-env node, browser, jasmine */
const { makeFixture } = require('./__helpers__/FixtureFS.js')
const path = require('path')
const pify = require('pify')
const concat = require('simple-concat')

const { packObjects } = require('isomorphic-git')

describe('packObjects', () => {
  it('git.packObjects', async () => {
    // Setup
    let { fs, dir, gitdir } = await makeFixture('test-packObjects')
    // Test
    // Note: I originally made this fixture with `echo test-branch | git pack-objects --revs --stdout --depth=0 > test-branch.pack`
    // My code produces all the same files in the same order according to git-verify-pack, but due to compression differences it isn't
    // binary identical to the one generated by git. Therefore the fixture is actually one made by isomorphic-git.
    let fixture = await pify(fs.readFile)(path.join(dir, 'test-branch.pack'))
    let { packstream: fstream } = await packObjects({
      fs,
      gitdir,
      refs: ['e10ebb90d03eaacca84de1af0a59b444232da99e']
    })
    let result = await pify(concat)(fstream)
    expect(fixture.buffer).toEqual(result.buffer)
  })
})
